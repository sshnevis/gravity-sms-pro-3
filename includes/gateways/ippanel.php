<?php
 class GFIPPANELSMS_Pro_IPPANEL { static $domain = "my.ippanel.app"; public static function construct() { } public static function name($gateways) { $name = __('IP Panel', 'GF_IPPanel'); $gateway = array(strtolower(str_replace('GFIPPANELSMS_Pro_', '', get_called_class())) => $name); return array_unique(array_merge($gateways, $gateway)); } public static function options() { return array( 'username' => __('User Name', 'GF_IPPanel'), 'password' => __('Password', 'GF_IPPanel'), 'domain' => __('SmsPanel Domain', 'GF_IPPanel') ); } public static function credit() { return true; } public static function checkPattern( $patternCode = null) { $patternCode = $_POST['patternCode']; if($patternCode){ $gateway = get_option( 'gf_ippanelsms_ippanel'); if(!isset($gateway['username']) || !isset($gateway['password'])) return array('status'=>-1,'message'=>'تنظیمات درگاه به درستی انجام نشده است.'); $params = array( 'uname' => trim($gateway['username']), 'pass' => trim($gateway['password']), 'patternCode'=> trim($patternCode), 'op'=> 'getPatternParams', ); $url = "/api/select"; $result = self::cUrl( $url, json_encode($params), 'POST' ); $response = json_decode($result,true); if (is_array($response) && isset($response['status']['code'])) { $status = $response['status']['code']; if($status == 0){ $patternMessage = $response['data']['patternMessage']; $patternParams = $response['data']['patternParams']; $result = array('status'=>$status,'message'=>$patternMessage,'vars'=>$patternParams); } else { $result = array('status'=>$status,'message'=>self::getPanelErrors($status)); } }else{ $result = array('status'=>-1,'message'=>'اشکالی در دریافت اطلاعات پترن به وجود آمد.'); } }else{ $result = array('status'=>-11,'message'=>'کد الگو را وارد نمایید.'); } return $result; } public static function process($options, $action, $from, $to, $message) { if ($action == 'credit' && !self::credit()) { return false; } if (!extension_loaded('curl')) return __('ماژول cURL بر روی هاست شما فعال نمی باشد .', 'GF_IPPanel'); $username = $options['username']; $password = $options['password']; if(isset($options['domain']) && $options['domain'] != '') self::$domain = $options['domain']; $to = explode(',', $to); $i = sizeOf($to); while ($i--) { $uNumber = Trim($to[$i]); $ret = &$uNumber; if (substr($uNumber, 0, 5) == '%2B98') { $ret = substr($uNumber, 5); } if (substr($uNumber, 0, 5) == '%2b98') { $ret = substr($uNumber, 5); } if (substr($uNumber, 0, 4) == '0098') { $ret = substr($uNumber, 4); } if (substr($uNumber, 0, 3) == '098') { $ret = substr($uNumber, 3); } if (substr($uNumber, 0, 3) == '+98') { $ret = substr($uNumber, 3); } if (substr($uNumber, 0, 2) == '98') { $ret = substr($uNumber, 2); } $to[$i] = $ret; } if ($action == "send") { $result = null; $result = apply_filters('gfippanelsms_send', $result ,array($username, $password, $to, $from, $message)); if($result) return $result; $message = str_replace(array('pcode','pid'),'patterncode',$message); if (substr($message, 0, 11) === "patterncode") { $response = self::sendPattern($username, $password, $to, $from, $message); } else { $url = "/services.jspd"; $params = array ( 'uname'=>$username, 'pass'=>$password, 'from'=>$from, 'message'=>$message, 'to'=>json_encode($to), 'op'=>'send' ); $result = self::cUrl( $url, $params, 'POST' ); $result2 = json_decode($result); $res_code = $result2[0]; $res_data = $result2[1]; if ($res_code == '0'){ $response = 'OK'; }else{ $response = self::getPanelErrors($res_code); } } return $response; } if ($action == "credit") { try { $params = array( 'uname' => $username, 'pass' => $password, 'op' => 'credit' ); $url ="/services.jspd";; $result = self::cUrl( $url, $params, 'POST' ); $response = json_decode($result); $res_code = $response[0]; $res_data = $response[1]; if ($res_code == '0'){ return round($res_data).' ریال'; }else{ return self::getPanelErrors($res_code); } } catch (Exception $ex) { return $ex->getMessage(); } } if ($action == "range") { $min = 1000; $max = 5000; return array("min" => $min, "max" => $max); } } public static function sendPattern($username, $password, $to, $from, $message){ $message = str_replace(array("\n\r\n","\r\n","\n"),";",$message); $message = str_replace("=",":",$message); $splited = explode(';', $message); $patterncodeArray = explode(':', $splited[0]); $patterncode = trim($patterncodeArray[1]); unset($splited[0]); $input_data = array(); foreach($splited as $parm){ $splited_parm = explode(':', $parm, 2); $input_data[$splited_parm[0]] = trim($splited_parm[1]); } foreach($to as $toNum){ $url = "/patterns/pattern?username=".urlencode($username)."&password=".urlencode($password)."&from=$from&to=".json_encode(array($toNum))."&input_data=".urlencode(json_encode($input_data))."&pattern_code=".$patterncode; $result = self::cUrl( $url, array(), 'GET' ); } $resultarray = json_decode($result); $response = 'OK'; if (is_array($resultarray) && $resultarray[0] != 'sent') { $res_code = $resultarray[0]; $res_data = $resultarray[1]; $response = self::getPanelErrors($res_code); } return $response; } private static function cUrl( $url, $params = array() , $method = 'POST' ) { $handler = curl_init(self::$domain.$url); curl_setopt($handler, CURLOPT_CONNECTTIMEOUT, 20); curl_setopt($handler, CURLOPT_TIMEOUT, 30); curl_setopt($handler, CURLOPT_CUSTOMREQUEST, $method); if($method == 'POST') curl_setopt($handler, CURLOPT_POSTFIELDS, $params); curl_setopt($handler, CURLOPT_RETURNTRANSFER, true); $result = curl_exec($handler); if (curl_errno($handler)) { $result = curl_error($handler); return json_encode(array('-10',$result)); } return $result; } private static function getPanelErrors($error){ $errorCodes = array( '-1' => 'اتصال به سامانه برقرار نشد. لطفا با پشتیبان سامانه پیامک تماس بگیرید.', '0' => 'عملیات با موفقیت انجام شده است.', '1' => 'متن پیام خالی می باشد.', '2' => 'کاربر محدود گردیده است.', '3' => 'خط به شما تعلق ندارد.', '4' => 'گیرندگان خالی است.', '5' => 'اعتبار کافی نیست.', '7' => 'خط مورد نظر برای ارسال انبوه مناسب نمیباشد.', '9' => 'خط مورد نظر در این ساعت امکان ارسال ندارد.', '98' => 'حداکثر تعداد گیرنده رعایت نشدهه است.', '99' => 'اپراتور خط ارسالی قطع می باشد.', '21' => 'پسوند فایل صوتی نامعتبر است.', '22' => 'سایز فایل صوتی نامعتبر است.', '23' => 'تعداد تالش در پیام صوتی نامعتبر است.', '100' => 'شماره مخاطب دفترچه تلفن نامعتبر می باشد.', '101' => 'شماره مخاطب در دفترچه تلفن وجود دارد.', '102' => 'شماره مخاطب با موفقیت در دفترچه تلفن ذخیره گردید.', '111' => 'حداکثر تعداد گیرنده برای ارسال پیام صوتی رعایت نشده است.', '131' => 'تعداد تالش در پیام صوتی باید یکبار باشد.', '132' => 'آدرس فایل صوتی وارد نگردیده است.', '266' => 'ارسال با خط اشتراکی امکان پذیر نیست.', '301' => 'از حرف ویژه در نام کاربری استفاده گردیده است.', '302' => 'قیمت گذاری انجام نگریدهه است.', '303' => 'نام کاربری وارد نگردیده است.', '304' => 'نام کاربری قبال انتخاب گردیده است.', '305' => 'نام کاربری وارد نگردیده است.', '306' => 'کد ملی وارد نگردیده است.', '307' => 'کد ملی به خطا وارد شده است.', '308' => 'شماره شناسنامه نا معتبر است.', '309' => 'شماره شناسنامه وارد نگردیده است.', '310' => 'ایمیل کاربر وارد نگردیده است.', '311' => 'شماره تلفن وارد نگردیده است.', '312' => 'تلفن به درستی وارد نگردیده است.', '313' => 'آدرس شما وارد نگردیده است.', '314' => 'شماره موبایل را وارد نکرده اید.', '315' => 'شماره موبایل به نادرستی وارد گردیده است.', '316' => 'سطح دسترسی به نادرستی وارد گردیده است.', '317' => 'کلمه عبور وارد نگردیده است.', '404' => 'پترن در دسترس نیست.', '455' => 'ارسال در آینده برای کد بالک ارسالی لغو شد.', '456' => 'کد بالک ارسالی نامعتبر است.', '458' => 'کد تیکت نامعتبر است.', '964' => 'شما دسترسی نمایندگی ندارید.', '962' => 'نام کاربری یا کلمه عبور نادرست می باشد.', '963' => 'دسترسی نامعتبر می باشد.', '971' => 'پترن ارسالی نامعتبر است.', '970' => 'پارامتر های ارسالی برای پترن نامعتبر است.', '972' => 'دریافت کننده برای ارسال پترن نامعتبر می باشد.', '992' => 'ارسال پیام از ساعت 8 تا 23 می باشد.', '993' => 'دفترچه تلفن باید یک آرایه باشد', '994' => 'لطفا تصویری از کارت بانکی خود را از منو مدارک ارسال کنید', '995' => 'جهت ارسال با خطوط اشتراکی سامانه، لطفا شماره کارت بانکیه خود را به دلیل تکمیل فرایند احراز هویت از بخش ارسال مدارک ثبت نمایید.', '996' => 'پترن فعال نیست.', '997' => 'شما اجازه ارسال از این پترن را ندارید.ه', '998' => 'کارت ملی یا کارت بانکی شما تایید نشده است.', '1001' => 'فرمت نام کاربری درست نمی باشد)حداقله ۵ کاراکتر، فقط حروف و اعداد(.', '1002' => 'گذر واژه خیلی ساده می باشد)حداقل ۸ کاراکتر بوده و نام کاربری،ایمی و شماره موبایل در آن وجود نداشته باشد).', '1003' => 'مشکل در ثبت، با پشتیبانی تماس بگیرید.', '1004' => 'مشکل در ثبت، با پشتیبانی تماس بگیرید.', '1005' => 'مشکل در ثبت، با پشتیبانی تماس بگیرید.', '1006' => 'تاریخ ارسال پیام برای گذشته می باشد، لطفا تاریخ ارسال پیام را به درستی وارد نمایید.', ); return (isset($errorCodes[$error])) ? $errorCodes[$error] : 'اشکال تعریف نشده با کد :' . $error; } } ?>
